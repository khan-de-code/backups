# Development Environment Zsh Configuration
# Generated by Ansible

# Path configuration
{% if is_macos %}
export PATH="{{ homebrew_prefix }}/bin:$PATH"
export PATH="$PATH:/Applications/Visual Studio Code.app/Contents/Resources/app/bin"
{% else %}
export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{% endif %}
export PATH="$HOME/.cargo/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# Environment variables
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border'
export FZF_DEFAULT_COMMAND="fd --hidden --follow ."
export FORCE_COLOR=1
export RIPGREP_CONFIG_PATH="$HOME/.ripgreprc"
export DOCKER_BUILDKIT=1

# Pyenv configuration
export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"

# Zsh options
setopt GLOB_DOTS
setopt AUTO_CD
setopt HIST_VERIFY
setopt SHARE_HISTORY
setopt APPEND_HISTORY
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000

# Completion system
{% if is_macos %}
fpath=({{ homebrew_prefix }}/share/zsh/site-functions $fpath)
{% endif %}
autoload -Uz compinit
compinit

# Case insensitive completion
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# Colored man pages
export LESS_TERMCAP_mb=$'\e[1;32m'
export LESS_TERMCAP_md=$'\e[1;32m'
export LESS_TERMCAP_me=$'\e[0m'
export LESS_TERMCAP_se=$'\e[0m'
export LESS_TERMCAP_so=$'\e[01;33m'
export LESS_TERMCAP_ue=$'\e[0m'
export LESS_TERMCAP_us=$'\e[1;4;31m'

# Aliases
alias ls='eza -l --icons --git --header --color-scale=age --color-scale-mode=gradient'
alias ll='ls -la'
alias la='ls -la'
alias l='ls -CF'
alias fd='fd --hidden'
alias rg='rg --hidden --glob "!.git"'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias grep='grep --color=auto'
alias clear='printf "\033c"'

# Git aliases
alias g='git'
alias ga='git add'
alias gaa='git add --all'
alias gb='git branch'
alias gba='git branch -a'
alias gc='git commit -v'
alias gcm='git commit -m'
alias gco='git checkout'
alias gd='git diff'
alias gl='git pull'
alias gp='git push'
alias gst='git status'
alias glg='git log --name-status'
alias glog='git log --oneline --decorate --graph'

# Docker aliases
alias dc='docker-compose'
alias dcu='docker-compose up'
alias dcd='docker-compose down'
alias dcb='docker-compose build'

# Custom functions
gsw() {
    local target_branch_name="$1"
    if git switch "$target_branch_name" 2>/dev/null; then
        return 0
    fi
    local IFS=$'\n'
    local local_branches=( $(git for-each-ref --format='%(refname:short)' --sort=committerdate refs/heads/) )
    unset IFS
    local remote_branches=$(git branch -r)
    local current_branch=$(git branch --show-current | tr -d '[:space:]') 
    local combined_branches=()
    for item in "${local_branches[@]}"; do
        if [[ "$item" != *"$current_branch"* ]]; then
            combined_branches+=("$item")
        fi
    done
    for item in "${remote_branches[@]}"; do
        trimmed_item=$(printf "%s" "$item" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        combined_branches+=("$trimmed_item")
    done
    if [ -n "$target_branch_name" ]; then
        branch_to_switch_to=$(printf "%s\n" "${combined_branches[@]}" | fzf --header "Current Branch: $current_branch" --query $target_branch_name)
    else
        branch_to_switch_to=$(printf "%s\n" "${combined_branches[@]}" | fzf --header "Current Branch: $current_branch")
    fi
    if [[ "$branch_to_switch_to" == origin/* ]]; then
        local local_branch_name="${branch_to_switch_to#origin/}"
        git switch -c "$local_branch_name" "$branch_to_switch_to"
    else
        git switch "$branch_to_switch_to"
    fi 
}

fzf-history() {
    local selected=$(history -n 1 | fzf --tac --no-sort)
    if [[ -n $selected ]]; then
        print -z "$selected"
    fi
}

# Key bindings
bindkey '^R' fzf-history
zle -N fzf-history

# Tool initializations
eval "$(starship init zsh)"
eval "$(direnv hook zsh)"
eval "$(zoxide init zsh)"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

# Tool completions
if command -v kubectl >/dev/null 2>&1; then
    source <(kubectl completion zsh)
fi

{% if is_linux %}
if command -v docker >/dev/null 2>&1; then
    source <(docker completion zsh)
fi
{% endif %}

# FZF key bindings and completion
source <(fzf --zsh)

# Syntax highlighting and autosuggestions
{% if is_macos %}
source {{ homebrew_prefix }}/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
source {{ homebrew_prefix }}/share/zsh-autosuggestions/zsh-autosuggestions.zsh
{% else %}
# Install via package manager on Linux
if [[ -f /usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
    source /usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi
if [[ -f /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
    source /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi
{% endif %}

# NVM configuration
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
